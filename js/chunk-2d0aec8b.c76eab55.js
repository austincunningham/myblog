(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2d0aec8b"],{"0c13":function(e,t,s){"use strict";s.r(t);var a=function(){var e=this,t=e.$createElement;e._self._c;return e._m(0)},r=[function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("section",[s("h1",[e._v("Keycloak 19.0.1 and Setting the id_token_hint")]),s("p",[e._v("description: id_token_hint and how to set it")]),s("p",[s("img",{attrs:{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/kd6paztfgofophghmtpy.png",alt:""}})]),s("p",[e._v("Created a blog some time ago setting up "),s("a",{attrs:{href:"https://austincunningham.ddns.net/2022/keycloakexpressoidcg"}},[e._v("keycloak express and OIDC client")]),e._v(" and it happily worked fine with keycloak-17.0.0 and still does. On keycloak-19.0.2 same code completely falls over. (Note to self always set prerequisites on dependencies in blogs).")]),s("p",[e._v("First issue I needed to enable Standard flow for the client in keycloak as I was seeing the following error in the logs")]),s("pre",{pre:!0},[s("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[e._v("2022-09-16 11:56:37,512 WARN  [org.keycloak.events] (executor-thread-0) "),s("span",{pre:!0,attrs:{class:"hljs-built_in"}},[e._v("type")]),e._v("=LOGIN_ERROR, realmId=78ae1441-0616-4745-b021-5ca93fc9f779, clientId=null, userId=null, ipAddress=127.0.0.1, error=invalid_code\n2022-09-16 11:58:56,673 ERROR [org.keycloak.services] (executor-thread-3) KC-SERVICES0095: Client is not allowed to initiate browser login with given response_type. Standard flow is disabled "),s("span",{pre:!0,attrs:{class:"hljs-keyword"}},[e._v("for")]),e._v(" the client.\n")])]),s("p",[e._v("It's in the "),s("code",{pre:!0},[e._v("Clients\\Capability config")]),e._v(" section")]),s("p",[s("img",{attrs:{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/5ijtn3qf6xrr79eiadey.png",alt:"screenshot of keycloak ui clients capability"}})]),s("p",[e._v("Secondly I was using localhost for my uri's in keycloak and in my code base and keycloak-19 did not play well with it. Changed everything to 127.0.0.1 and most routes started working again. With the exception of logout. I was hitting the following issue.")]),s("p",[s("img",{attrs:{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ph8527vbtx9yef50c9j4.png",alt:"keycloak logout id_token_hint error screenshot"}})]),s("p",[e._v("The keycloak logs had a similar error with more details.")]),s("pre",{pre:!0},[s("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[e._v("2022-09-16 13:00:28,208 WARN  [org.keycloak.events] (executor-thread-57) "),s("span",{pre:!0,attrs:{class:"hljs-built_in"}},[e._v("type")]),e._v("=LOGOUT_ERROR, realmId=1bfc6eb7-ffa8-497f-96cc-69840b6c3f39, clientId=null, userId=null, ipAddress=127.0.0.1, error=invalid_request\n2022-09-16 13:11:48,730 WARN  [org.keycloak.protocol.oidc.endpoints.LogoutEndpoint] (executor-thread-75) Either the parameter "),s("span",{pre:!0,attrs:{class:"hljs-string"}},[e._v("'client_id'")]),e._v(" or the parameter "),s("span",{pre:!0,attrs:{class:"hljs-string"}},[e._v("'id_token_hint'")]),e._v(" is required when "),s("span",{pre:!0,attrs:{class:"hljs-string"}},[e._v("'post_logout_redirect_uri'")]),e._v(" is used.\n")])]),s("p",[e._v("So because I was using "),s("code",{pre:!0},[e._v("post_logout_redirect_uri")]),e._v(" I need to use either "),s("code",{pre:!0},[e._v("client_id")]),e._v(" or "),s("code",{pre:!0},[e._v("id_token_hint")]),e._v(" parameter. So I had three options")]),s("ul",[s("li",[e._v("stop using "),s("code",{pre:!0},[e._v("post_logout_rediret_uri")])]),s("li",[e._v("add a "),s("code",{pre:!0},[e._v("client_id")]),e._v(" parameter to "),s("code",{pre:!0},[e._v("post_logout_redirect_uri")])]),s("li",[e._v("add a "),s("code",{pre:!0},[e._v("id_token_hint")]),e._v(" parameter to "),s("code",{pre:!0},[e._v("post_logout_redirect_uri")])])]),s("h2",[e._v("Stop using post_logout_redirect_uri")]),s("p",[e._v("Remove it from the keycloakeIssuer.Client")]),s("pre",{pre:!0},[s("code",{pre:!0,attrs:{"v-pre":"",class:"language-js"}},[s("span",{pre:!0,attrs:{class:"hljs-keyword"}},[e._v("const")]),e._v(" keycloakIssuer = "),s("span",{pre:!0,attrs:{class:"hljs-keyword"}},[e._v("await")]),e._v(" Issuer.discover("),s("span",{pre:!0,attrs:{class:"hljs-string"}},[e._v('"http://127.0.0.1:8080/realms/keycloak-express"')]),e._v(")\n"),s("span",{pre:!0,attrs:{class:"hljs-comment"}},[e._v("// I just comment out the line in the client ")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"hljs-keyword"}},[e._v("const")]),e._v(" client = "),s("span",{pre:!0,attrs:{class:"hljs-keyword"}},[e._v("new")]),e._v(" keycloakIssuer.Client({\n    "),s("span",{pre:!0,attrs:{class:"hljs-attr"}},[e._v("client_id")]),e._v(": "),s("span",{pre:!0,attrs:{class:"hljs-string"}},[e._v("'keycloak-express'")]),e._v(",\n    "),s("span",{pre:!0,attrs:{class:"hljs-attr"}},[e._v("client_secret")]),e._v(": "),s("span",{pre:!0,attrs:{class:"hljs-string"}},[e._v("'long_secret-here'")]),e._v(",\n    "),s("span",{pre:!0,attrs:{class:"hljs-attr"}},[e._v("redirect_uris")]),e._v(": ["),s("span",{pre:!0,attrs:{class:"hljs-string"}},[e._v("'http://127.0.0.1:3000/auth/callback'")]),e._v("],\n    "),s("span",{pre:!0,attrs:{class:"hljs-comment"}},[e._v("//post_logout_redirect_uris: ['http://127.0.0.1:3000/logout/callback'],")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"hljs-attr"}},[e._v("response_types")]),e._v(": ["),s("span",{pre:!0,attrs:{class:"hljs-string"}},[e._v("'code'")]),e._v("],\n  });\n")])]),s("p",[e._v("Looks like this it prompts for a logout and leaves you at a keycloak logged out screen.\n"),s("img",{attrs:{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7ban9kgffjx05wv4oxxk.gif",alt:"screen grab of logout without post_logout_redirect_uri "}})]),s("h2",[e._v("Add client_id parameter")]),s("p",[e._v("We have set the client_id in the "),s("code",{pre:!0},[e._v("keycloakeIssuer.Client")]),e._v(" so it just a matter of setting it in the logout as a parameter")]),s("pre",{pre:!0},[s("code",{pre:!0,attrs:{"v-pre":"",class:"language-js"}},[s("span",{pre:!0,attrs:{class:"hljs-comment"}},[e._v("// start logout request")]),e._v("\napp.get("),s("span",{pre:!0,attrs:{class:"hljs-string"}},[e._v("'/logout'")]),e._v(", (req, res) => {\n    res.redirect(client.endSessionUrl({\n        "),s("span",{pre:!0,attrs:{class:"hljs-attr"}},[e._v("client_id")]),e._v(": "),s("span",{pre:!0,attrs:{class:"hljs-string"}},[e._v('"keycloak-express"')]),e._v("\n    }\n    ));\n});\n")])]),s("p",[e._v("Looks like this as you can see it ask for another confirmation before redirecting to the app.")]),s("p",[s("img",{attrs:{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/dkhredgl17nmk8u3rpxo.gif",alt:"screen grab of logout with client_id parameter set"}})]),s("h2",[e._v("Add id_token_hint parameter")]),s("p",[e._v("What is "),s("code",{pre:!0},[e._v("id_token_hint")]),e._v(" and how do I populate it?\nMe I am terrible at reading/comprehending documentation and much prefer a good example. In this case I didn't find any examples. I found the following documentation referencing "),s("code",{pre:!0},[e._v("id_token_hint")])]),s("ul",[s("li",[s("a",{attrs:{href:"https://openid.net/specs/openid-connect-rpinitiated-1_0.html"}},[e._v("OpenID Connect RP-Initiated Logout ")]),e._v(" which I found too abstract to formulate what to do to generating "),s("code",{pre:!0},[e._v("id_token_hint")]),e._v(" or find it.")]),s("li",[s("a",{attrs:{href:"https://github.com/panva/node-openid-client/tree/main/docs#clientendsessionurlparameters"}},[e._v("the node-oidc-client")]),e._v(" gave me a hint")])]),s("p",[s("img",{attrs:{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/zqpdcyj45d10jrxdjj0n.png",alt:"Image of the node-oidc-client docs"}})]),s("p",[e._v("There is a tokenSet object that is created as part of the passportjs strategy login flow. I inspected this object and found that it has a "),s("code",{pre:!0},[e._v("id_token")]),e._v(" and I made this "),s("code",{pre:!0},[e._v("id_token_hint = id_token")]),e._v(" and my issue was solved.")]),s("p",[e._v("So I was using passwordjs and node-openid-client")]),s("pre",{pre:!0},[s("code",{pre:!0,attrs:{"v-pre":"",class:"language-js"}},[s("span",{pre:!0,attrs:{class:"hljs-keyword"}},[e._v("var")]),e._v(" TokenSet\npassport.use("),s("span",{pre:!0,attrs:{class:"hljs-string"}},[e._v("'oidc'")]),e._v(", "),s("span",{pre:!0,attrs:{class:"hljs-keyword"}},[e._v("new")]),e._v(" Strategy({client}, (tokenSet, userinfo, done)=>{\n        TokenSet = tokenSet;\n        "),s("span",{pre:!0,attrs:{class:"hljs-keyword"}},[e._v("return")]),e._v(" done("),s("span",{pre:!0,attrs:{class:"hljs-literal"}},[e._v("null")]),e._v(", tokenSet.claims());\n    })\n)\n"),s("span",{pre:!0,attrs:{class:"hljs-comment"}},[e._v("//And on logout we can set the id_token_hint parameter")]),e._v("\napp.get("),s("span",{pre:!0,attrs:{class:"hljs-string"}},[e._v("'/logout'")]),e._v(", (req, res) => {\n    res.redirect(client.endSessionUrl({\n        "),s("span",{pre:!0,attrs:{class:"hljs-attr"}},[e._v("id_token_hint")]),e._v(": TokenSet.id_token\n    }\n    ));\n});\n")])]),s("p",[e._v("Looks like this and is a much better user experience")]),s("p",[s("img",{attrs:{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/v6nk3g3bqslzeuv9vnhw.gif",alt:"screen grab of logout with id_token_hint parameter set"}})]),s("p",[e._v("Code lives "),s("a",{attrs:{href:"https://github.com/austincunningham/keycloak-express-openid-client/tree/keycloak-19"}},[e._v("here")])])])}],n=s("2877"),o={},i=Object(n["a"])(o,a,r,!1,null,null,null);t["default"]=i.exports}}]);
//# sourceMappingURL=chunk-2d0aec8b.c76eab55.js.map