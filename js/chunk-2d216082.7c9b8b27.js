(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2d216082"],{c175:function(s,t,a){"use strict";a.r(t);var e=function(){var s=this,t=s.$createElement;s._self._c;return s._m(0)},r=[function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("section",[a("h1",[s._v("Get Prometheus Metrics from a Express.js app")]),a("p",[a("img",{attrs:{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/2wgqholbtjqe661gavan.png",alt:"banner image"}})]),a("h2",[s._v("Expose the metrics in Express.js app")]),a("p",[s._v("I use Prometheus all the time for metrics and alert monitoring in Kubernetes. I decided to see how to setup monitoring in a Node/Express.js app. A quick search of npmjs and I found these two package "),a("a",{attrs:{href:"https://www.npmjs.com/package/prom-client"}},[s._v("prom-client")]),s._v(" a really detailed Prometheus client and "),a("a",{attrs:{href:"https://www.npmjs.com/package/express-prom-bundle"}},[s._v("express-prom-bundle")]),s._v(" which uses "),a("code",{pre:!0},[s._v("prom-client")]),s._v(" under the hood, I choose "),a("code",{pre:!0},[s._v("express-prom-bundle")]),s._v(" as it was a quick win and was producing metrics with a few lines of code, my repo is "),a("a",{attrs:{href:"https://github.com/austincunningham/express-prometheus"}},[s._v("here")]),s._v(". I installed the following packages in my express app")]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v("npm install prom-client express-prom-bundle --save\n")])]),a("p",[s._v("Then added the Prometheus middleware to all routes")]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-js"}},[a("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" express = "),a("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("require")]),s._v("("),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'express'")]),s._v(");\n"),a("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" app = express();\n"),a("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" promBundle = "),a("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("require")]),s._v("("),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"express-prom-bundle"')]),s._v(");\n\n"),a("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// Add the options to the prometheus middleware most option are for http_request_duration_seconds histogram metric")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" metricsMiddleware = promBundle({\n    "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("includeMethod")]),s._v(": "),a("span",{pre:!0,attrs:{class:"hljs-literal"}},[s._v("true")]),s._v(", \n    "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("includePath")]),s._v(": "),a("span",{pre:!0,attrs:{class:"hljs-literal"}},[s._v("true")]),s._v(", \n    "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("includeStatusCode")]),s._v(": "),a("span",{pre:!0,attrs:{class:"hljs-literal"}},[s._v("true")]),s._v(", \n    "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("includeUp")]),s._v(": "),a("span",{pre:!0,attrs:{class:"hljs-literal"}},[s._v("true")]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("customLabels")]),s._v(": {"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("project_name")]),s._v(": "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'hello_world'")]),s._v(", "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("project_type")]),s._v(": "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'test_metrics_labels'")]),s._v("},\n    "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("promClient")]),s._v(": {\n        "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("collectDefaultMetrics")]),s._v(": {\n        }\n      }\n});\n"),a("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// add the prometheus middleware to all routes")]),s._v("\napp.use(metricsMiddleware)\n\n"),a("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// default endpoint ")]),s._v("\napp.get("),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"/"')]),s._v(",(req,res) => res.json({\n    "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"GET /"')]),s._v(": "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"All Routes"')]),s._v(", \n    "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"GET /hello"')]),s._v(": "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"{hello:world}"')]),s._v(", \n    "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"GET /metrics"')]),s._v(": "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"Metrics data"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"POST /bye"')]),s._v(": "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"POST Request: + post data"')]),s._v("\n}));\n"),a("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// hello world rest endpoint ")]),s._v("\napp.get("),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"/hello"')]),s._v(", (req,res) => res.json({"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("hello")]),s._v(":"),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"world"')]),s._v("}));\napp.post("),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"/bye"')]),s._v(", (req,res) => res.send("),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"POST Request : "')]),s._v("+ req));\n\napp.listen("),a("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("8080")]),s._v(", "),a("span",{pre:!0,attrs:{class:"hljs-function"}},[a("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v(" ("),a("span",{pre:!0,attrs:{class:"hljs-params"}}),s._v(") ")]),s._v("{    \n    "),a("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log("),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'Listening at http://localhost:8080'")]),s._v(");  \n  });\n")])]),a("p",[s._v("Running the app")]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v("npm start\n> express-prometheus@1.0.0 start /home/austincunningham/repo/express-prometheus\n> node index.js\n\nListening at http://localhost:8080\n\n"),a("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("# curl the hello world endpoint")]),s._v("\ncurl localhost:8080/hello\n{"),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"hello"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"world"')]),s._v("}%                                                                                                     \n\n"),a("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("# curl the metrics endpoint")]),s._v("\ncurl localhost:8080/metrics\n"),a("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("# HELP process_cpu_user_seconds_total Total user CPU time spent in seconds.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("# TYPE process_cpu_user_seconds_total counter")]),s._v("\nprocess_cpu_user_seconds_total 0.120868\n"),a("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("# I cut the metrics output short here as its a lot of text but you get the idea")]),s._v("\n")])]),a("h2",[s._v("Setup the Express app on Openshift")]),a("p",[s._v("I am using "),a("a",{attrs:{href:"https://access.redhat.com/documentation/en-us/red_hat_codeready_containers/1.0/html/getting_started_guide/getting-started-with-codeready-containers_gsg"}},[s._v("crc")]),s._v(" which is local Kubernetes development environment based on Red Hat Openshift. I create a container for the app based on the following DockerFile")]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":""}},[s._v('# syntax=docker/dockerfile:1\n\nFROM node:12.18.1\n\nWORKDIR /app\n\nCOPY ["package.json", "package-lock.json*", "./"]\n\nRUN npm install \n\nCOPY . .\n\nCMD [ "node", "index.js" ]\n')])]),a("p",[s._v("I then build, test the image locally and push the image")]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v("docker build -t quay.io/austincunningham/express-prometheus:v1.0.0 .\ndocker run -p 8080:8080 quay.io/austincunningham/express-prometheus:v1.0.0\nListening at http://localhost:8080\ndocker push quay.io/austincunningham/express-prometheus:v1.0.0\n")])]),a("p",[s._v("I can then deploy this on crc/openshift with the following two files\n"),a("strong",[s._v("deployment.yaml")])]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-yaml"}},[a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("apiVersion:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("apps/v1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("kind:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("Deployment")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("metadata:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("name:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("example-app")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("spec:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("replicas:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("3")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("selector:")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("matchLabels:")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("app:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("example-app")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("template:")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("metadata:")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("labels:")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("app:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("example-app")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("spec:")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("containers:")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"hljs-bullet"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("name:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("example-app")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("image:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("quay.io/austincunningham/express-prometheus:v1.0.0")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("ports:")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"hljs-bullet"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("name:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("web")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("containerPort:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("8080")]),s._v("\n")])]),a("p",[a("strong",[s._v("service.yaml")])]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-yaml"}},[a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("kind:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("Service")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("apiVersion:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("v1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("metadata:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("name:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("example-app")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("labels:")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("app:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("example-app")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("#--\x3e this is used for scraping the service via the serviceMonitor")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("spec:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("selector:")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("app:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("example-app")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("ports:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-bullet"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("name:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("web")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("port:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("8080")]),s._v("\n")])]),a("p",[s._v("Apply the files to the default project")]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v("oc project default\noc apply -f deployment.yaml\noc apply -f service.yaml \nservice/example-app created\n"),a("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("# create a route to the service so you can access from the browser")]),s._v("\noc expose service example-app \nroute.route.openshift.io/example-app exposed\n")])]),a("p",[s._v("You can test the route by hitting the /metrics path in the browser you should see")]),a("p",[a("img",{attrs:{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/w20ytvf0lzemd7j6x86q.png",alt:"metrics screen shot"}})]),a("h2",[s._v("Setup Prometheus Operator on Openshift")]),a("p",[s._v("I am following the "),a("a",{attrs:{href:"https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/user-guides/getting-started.md"}},[s._v("prometheus operator getting started guide")]),s._v(". Applied the bundle from the setup on the default namespace")]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v("oc project default\noc apply -f https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/bundle.yaml\n")])]),a("blockquote",[a("p",[a("em",[s._v("NOTE")]),s._v(": Hit a issue where the prometheus-operator pod was in a crash loop backoff :(")])]),a("p",[s._v("Openshift has an operator hub so I did the following to fix the crashing operator pod. First I deleted the existing prometheus-operator deployment")]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v("oc delete deployment prometheus-operator\n")])]),a("p",[s._v("Logged in to crc/Openshift console as kubeadmin, in the administrator view go to OperatorHub and search for prometheus")]),a("p",[a("img",{attrs:{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/a1jcm9lxb72ios6nwbe9.png",alt:"administrator view go to operator hub and search for prometheus"}})]),a("p",[s._v("Select the "),a("code",{pre:!0},[s._v("Prometheus Operator")]),s._v(" tile and "),a("code",{pre:!0},[s._v("continue")]),s._v(" then select "),a("code",{pre:!0},[s._v("install")]),s._v(" button")]),a("p",[a("img",{attrs:{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/3t4bab24d4pwj2oddo2a.png",alt:"Install Prometheus button"}})]),a("p",[s._v("Select the default namespace from the drop down and install button again")]),a("p",[a("img",{attrs:{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/ov7novmbck4f30fo0vf1.png",alt:"Install Prometheus button"}})]),a("p",[s._v("Phew! that took longer to explain that to do.")]),a("h2",[s._v("Steps to get Prometheus to see the Express.js apps metrics")]),a("p",[s._v("First we add the Prometheus CR(custom resource) to the default namespace to start the Prometheus instance\n"),a("strong",[s._v("prometheus.yaml")])]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-yaml"}},[a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("apiVersion:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("monitoring.coreos.com/v1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("kind:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("Prometheus")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("metadata:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("name:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("prometheus")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("spec:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("serviceAccountName:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("prometheus")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("serviceMonitorSelector:")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("matchLabels:")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("team:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("frontend")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("# --\x3e this is used by prometheus to scrape the serviceMonitor")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("resources:")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("requests:")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("memory:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("400Mi")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("enableAdminAPI:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-literal"}},[s._v("false")]),s._v("\n")])]),a("p",[s._v("And add the service\n"),a("strong",[s._v("prometheus-service.yaml")])]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-yaml"}},[a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("kind:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("Service")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("apiVersion:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("v1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("metadata:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("name:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("prometheus-operated")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("namespace:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("default")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("labels:")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("operated-prometheus:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'true'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("spec:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("ports:")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"hljs-bullet"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("name:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("web")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("protocol:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("TCP")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("port:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("9090")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("targetPort:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("web")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("selector:")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("app:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("prometheus")]),s._v("\n")])]),a("p",[s._v("Apply the files and create a route")]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v("oc apply -f prometheus.yaml\noc apply -f prometheus-service.yaml\noc expose service prometheus-operated\n")])]),a("p",[s._v("The way Prometheus scrapes metrics is that it uses a service monitor to check a "),a("code",{pre:!0},[s._v("service")]),s._v(" for a particular label. We have already created the service when we deployed the example-app with the label "),a("code",{pre:!0},[s._v("app: example-app")]),s._v(" in metadata.labels.")]),a("p",[s._v("Next we create a serviceMonitor in the default namespace and with a "),a("code",{pre:!0},[s._v("selector")]),s._v(" for the "),a("code",{pre:!0},[s._v("app: example-app")]),s._v(" label. So we create the following file.\n"),a("strong",[s._v("service-monitor.yaml")])]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-yaml"}},[a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("apiVersion:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("monitoring.coreos.com/v1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("kind:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("ServiceMonitor")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("metadata:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("name:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("example-app")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("labels:")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("team:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("frontend")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("# --\x3e this should match the serviceMonitorSelector in the prometheus CR")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("spec:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("selector:")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("matchLabels:")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("app:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("example-app")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("# --\x3e this should match the label in the service in example-app")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("endpoints:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-bullet"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("port:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("web")]),s._v("\n")])]),a("blockquote",[a("p",[a("strong",[s._v("NOTE")]),s._v(" metadata.labels "),a("code",{pre:!0},[s._v("team: frontend")]),s._v(" we will use this later.")])]),a("p",[s._v("We upload the service-monitor.yaml file to the default namespace to create the serviceMonitor")]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v("oc apply -f service-monitor.yaml\n")])]),a("p",[s._v("In the prometheus.yaml CR we have already selected the service monitor this is done via "),a("code",{pre:!0},[s._v("serviceMonitorSelector")]),s._v(" label with the label "),a("code",{pre:!0},[s._v("team: frontend")])]),a("p",[s._v("Finally we need some "),a("a",{attrs:{href:"https://kubernetes.io/docs/reference/access-authn-authz/rbac/"}},[s._v("RBAC")]),s._v(" rules which is Kubernetes version of permissions to allow Prometheus to see everything")]),a("p",[s._v("Setup a service account, clusterRole and clusterRoleBinding. Create the following files\n"),a("strong",[s._v("service-account.yaml")])]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-yaml"}},[a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("apiVersion:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("v1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("kind:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("ServiceAccount")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("metadata:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("name:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("prometheus")]),s._v("\n")])]),a("p",[a("strong",[s._v("clusterRole.yaml")])]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-yaml"}},[a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("apiVersion:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("rbac.authorization.k8s.io/v1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("kind:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("ClusterRole")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("metadata:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("name:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("prometheus")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("rules:")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-bullet"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("apiGroups:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('[""]')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("resources:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-bullet"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("nodes")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-bullet"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("nodes/metrics")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-bullet"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("services")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-bullet"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("endpoints")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-bullet"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("pods")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("verbs:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('["get",')]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"list"')]),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"watch"')]),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-bullet"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("apiGroups:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('[""]')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("resources:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-bullet"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("configmaps")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("verbs:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('["get"]')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-bullet"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("apiGroups:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-bullet"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("networking.k8s.io")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("resources:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-bullet"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("ingresses")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("verbs:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('["get",')]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"list"')]),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"watch"')]),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-bullet"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("nonResourceURLs:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('["/metrics"]')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("verbs:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('["get"]')]),s._v("\n")])]),a("p",[a("strong",[s._v("clusterRoleBinding.yaml")])]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-yaml"}},[a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("apiVersion:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("rbac.authorization.k8s.io/v1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("kind:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("ClusterRoleBinding")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("metadata:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("name:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("prometheus")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("roleRef:")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("apiGroup:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("rbac.authorization.k8s.io")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("kind:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("ClusterRole")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("name:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("prometheus")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("subjects:")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"hljs-bullet"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("kind:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("ServiceAccount")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("name:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("prometheus")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("namespace:")]),s._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("default")]),s._v("\n")])]),a("p",[s._v("Apply the files to the default namespace")]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v("oc apply -f service-account.yaml \noc apply -f clusterRole.yaml \noc apply -f clusterRoleBinding.yaml \n")])]),a("p",[s._v("You should be able to access the route the default namespace")]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v("oc get routes \nNAME          HOST/PORT                              PATH   SERVICES      PORT   TERMINATION   WILDCARD\nexample-app   example-app-default.apps-crc.testing          example-app   web                  None\nprometheus    prometheus-default.apps-crc.testing           prometheus    web                  None\n")])]),a("p",[s._v("You can open the Prometheus UI by adding a http:// to the Prometheus HOST/PORT returned from the oc get routes command")]),a("p",[a("img",{attrs:{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/yquddzw2fh85ivwn0uj3.png",alt:"prometheus UI"}})]),a("h2",[s._v("So how do you know if its working")]),a("p",[s._v("It takes a little while for the Prometheus operator to reconcile and to show up the new resources. In the Prometheus ui first check the "),a("code",{pre:!0},[s._v("Status\\Service Discovery")]),s._v(" you should see example-app show up")]),a("p",[a("img",{attrs:{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/s1l94sqtx5xe18wcnrwt.png",alt:"screenshot status\\service discovery"}})]),a("blockquote",[a("p",[a("strong",[s._v("NOTE:")]),s._v(" be patient it can take a while to show up")])]),a("p",[s._v("Then check the "),a("code",{pre:!0},[s._v("Status\\Targets")]),s._v(" should see the following targets up")]),a("p",[a("img",{attrs:{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/y0oskurti0tk67r7zrqo.png",alt:"screenshot status\\targets up"}})]),a("p",[s._v("You also should be able to see metrics from example-app in the graph tab")]),a("p",[a("img",{attrs:{src:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/pa6yziyxuy853xhk2hzo.png",alt:"screenshot of the graph tab showing example-apps metrics"}})]),a("p",[s._v("That it I may do a follow up on (setting up Grafana)[https://austincunningham.ddns.net/2021/expressgrafana] to use these metrics")])])}],p=a("2877"),n={},l=Object(p["a"])(n,e,r,!1,null,null,null);t["default"]=l.exports}}]);
//# sourceMappingURL=chunk-2d216082.7c9b8b27.js.map